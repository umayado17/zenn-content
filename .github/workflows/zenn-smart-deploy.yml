# .github/workflows/zenn-smart-deploy.yml
name: Zenn Smart Deploy

on:
  schedule:
    # 6æ™‚é–“ãŠãã«å®Ÿè¡Œ
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ24æ™‚é–“åˆ¶é™ã‚’ç„¡è¦–ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # æœ€å¾Œã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»ã‚’ãƒã‚§ãƒƒã‚¯
    - name: Check last deploy time
      id: check_timing
      run: |
        # æœ€å¾Œã®æˆåŠŸã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¢ã™
        LAST_DEPLOY_COMMIT=$(git log --grep="Zenn deploy success" --format="%H" -n 1)
        
        if [ -z "$LAST_DEPLOY_COMMIT" ]; then
          echo "can_deploy=true" >> $GITHUB_OUTPUT
          echo "reason=First deployment" >> $GITHUB_OUTPUT
        else
          # æœ€å¾Œã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‹ã‚‰24æ™‚é–“çµŒéã—ãŸã‹ãƒã‚§ãƒƒã‚¯
          LAST_DEPLOY_TIME=$(git show -s --format=%ct $LAST_DEPLOY_COMMIT)
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_DEPLOY_TIME))
          HOURS_PASSED=$((TIME_DIFF / 3600))
          
          if [ $HOURS_PASSED -ge 24 ] || [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
            echo "can_deploy=true" >> $GITHUB_OUTPUT
            echo "reason=24 hours passed (${HOURS_PASSED}h) or forced" >> $GITHUB_OUTPUT
          else
            echo "can_deploy=false" >> $GITHUB_OUTPUT
            REMAINING_HOURS=$((24 - HOURS_PASSED))
            echo "reason=Need to wait ${REMAINING_HOURS} more hours" >> $GITHUB_OUTPUT
          fi
        fi
    
    # æ–°ã—ã„è¨˜äº‹ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
    - name: Check for article changes
      id: check_articles
      if: steps.check_timing.outputs.can_deploy == 'true'
      run: |
        # æœ€å¾Œã®ãƒ‡ãƒ—ãƒ­ã‚¤ä»¥é™ã®è¨˜äº‹å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
        LAST_DEPLOY_COMMIT=$(git log --grep="Zenn deploy success" --format="%H" -n 1)
        
        if [ -z "$LAST_DEPLOY_COMMIT" ]; then
          # åˆå›ã®å ´åˆã€å…¨ã¦ã®è¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯
          NEW_ARTICLES=$(find articles/ -name "*.md" -o -name "*.mdx" 2>/dev/null | wc -l)
        else
          # å¤‰æ›´ã•ã‚ŒãŸè¨˜äº‹ã‚’ãƒã‚§ãƒƒã‚¯
          NEW_ARTICLES=$(git diff --name-only $LAST_DEPLOY_COMMIT HEAD articles/ | grep -E "\.(md|mdx)$" | wc -l)
        fi
        
        echo "article_count=$NEW_ARTICLES" >> $GITHUB_OUTPUT
        
        if [ $NEW_ARTICLES -gt 0 ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          # å¤‰æ›´ã•ã‚ŒãŸè¨˜äº‹ä¸€è¦§ã‚’è¡¨ç¤º
          echo "Changed articles:"
          if [ -z "$LAST_DEPLOY_COMMIT" ]; then
            find articles/ -name "*.md" -o -name "*.mdx" 2>/dev/null || echo "No articles found"
          else
            git diff --name-only $LAST_DEPLOY_COMMIT HEAD articles/ | grep -E "\.(md|mdx)$" || echo "No article changes"
          fi
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
    - name: Deploy to Zenn
      if: steps.check_timing.outputs.can_deploy == 'true' && steps.check_articles.outputs.has_changes == 'true'
      run: |
        echo "Deploying ${{ steps.check_articles.outputs.article_count }} articles to Zenn..."
        echo "Deploy reason: ${{ steps.check_timing.outputs.reason }}"
        
        # Gitè¨­å®š
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã‚’ãƒãƒ¼ã‚¯
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        git commit --allow-empty -m "Zenn deploy success: $TIMESTAMP

        Deployed ${{ steps.check_articles.outputs.article_count }} articles
        Reason: ${{ steps.check_timing.outputs.reason }}"
        
        git push origin main
        
        echo "âœ… Deployment completed successfully!"
    
    # ã‚¹ã‚­ãƒƒãƒ—ã—ãŸå ´åˆã®ç†ç”±è¡¨ç¤º
    - name: Skip deployment
      if: steps.check_timing.outputs.can_deploy != 'true' || steps.check_articles.outputs.has_changes != 'true'
      run: |
        if [ "${{ steps.check_timing.outputs.can_deploy }}" != "true" ]; then
          echo "â° Deployment skipped: ${{ steps.check_timing.outputs.reason }}"
        elif [ "${{ steps.check_articles.outputs.has_changes }}" != "true" ]; then
          echo "ğŸ“ No new articles to deploy"
        fi
        
        # æ¬¡å›å®Ÿè¡Œäºˆå®šã‚’è¡¨ç¤º
        NEXT_RUN=$(date -d "+6 hours" '+%Y-%m-%d %H:%M:%S UTC')
        echo "Next check scheduled at: $NEXT_RUN"
